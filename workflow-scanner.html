<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse Workflow Scanner</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .container { padding: 20px; text-align: center; }
    #video { width: 500px; height: 200px; max-width: 90vw; border: 2px solid #007bff; object-fit: cover; }
    .settings-tab { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; margin: 15px 0; }
    .settings-header { padding: 10px 15px; background: #e9ecef; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; }
    .settings-content { padding: 15px; display: none; }
    .control-group { margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
    input[type="range"] { width: 150px; }
    .settings-content button { padding: 8px 12px; margin: 5px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; }
    input { width: 90%; padding: 15px; font-size: 18px; margin: 10px; }
    button { width: 90%; padding: 15px; font-size: 18px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; }
    .workflow-status { background: #f8f9fa; padding: 15px; margin: 15px; border-radius: 8px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    .order-items { text-align: left; margin: 15px 0; }
    .item { padding: 8px; margin: 5px 0; border-radius: 4px; }
    .item.found { background: #d4edda; }
    .item.pending { background: #fff3cd; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Warehouse Workflow Scanner (Native API)</h2>
    <p><a href="index.html">‚Üê Back to Quagga API scanner</a></p>
    
    <div style="background: #e8f5e8; padding: 10px; margin: 10px; border-radius: 5px;">
      <strong>üèÜ Using Best Scanner:</strong> Native Barcode Detection API for fastest, most accurate scanning
    </div>
    
    <div class="settings-tab">
      <div class="settings-header" onclick="toggleSettings()">
        ‚öôÔ∏è Camera Settings (Click to expand)
      </div>
      <div class="settings-content" id="settings-content">
        <div class="control-group">
          <label>Zoom:</label>
          <input type="range" id="zoom" min="1" max="10" step="0.1" value="1">
          <span id="zoom-value">1x</span>
        </div>
        <div class="control-group">
          <button onclick="resetZoom()">Reset Zoom</button>
          <button onclick="toggleTorch()">Toggle Flashlight</button>
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">
          Available controls: <span id="capabilities">Start scanner to see capabilities</span>
        </div>
      </div>
    </div>
    
    <div class="workflow-status" id="workflow-status">
      <h3>Step 1: Scan Picking Slip</h3>
      <p>Scan barcode: <strong>012345678905</strong> to load order</p>
    </div>
    
    <div style="position: relative; display: inline-block;">
      <video id="video" autoplay muted playsinline></video>
      <div class="scan-guide" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; border: 2px solid #00ff00; width: 250px; height: 150px; border-radius: 8px; background: rgba(0, 255, 0, 0.1);"></div>
    </div>
    
    <input type="text" id="result" placeholder="Scanned result appears here" readonly>
    <button id="start-btn" onclick="startScanner()">Start Scanner</button>
    <button id="stop-btn" onclick="stopScanner()" style="display:none;">Stop Scanner</button>
    
    <div class="order-items" id="order-items" style="display:none;">
      <h3>Order Items to Pick:</h3>
      <div id="items-list"></div>
    </div>
  </div>

  <script>
    // Dummy order data with mixed 1D and 2D barcodes
    const orders = {
      "012345678905": {
        orderId: "ORD-001",
        items: [
          { barcode: "HELLO123", name: "Product A (1D)", quantity: 2, found: 0 },
          { barcode: "4012345678901", name: "Product B (1D)", quantity: 1, found: 0 },
          { barcode: "TEST123", name: "Product C (1D)", quantity: 1, found: 0 },
          { barcode: "QR-ITEM-001", name: "Product D (2D)", quantity: 2, found: 0 },
          { barcode: "https://example.com/item/123", name: "Product E (2D)", quantity: 1, found: 0 }
        ]
      }
    };
    
    let currentOrder = null;
    let workflowStep = "picking_slip"; // "picking_slip" or "items"
    let barcodeDetector;
    let isScanning = false;
    let stream;
    let videoTrack;
    let scanInterval;
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 750; // 750ms between scans
    
    function updateWorkflowStatus(message, type = "info") {
      const statusDiv = document.getElementById('workflow-status');
      statusDiv.className = `workflow-status ${type}`;
      statusDiv.innerHTML = message;
    }
    
    function displayOrderItems() {
      if (!currentOrder) return;
      
      const itemsList = document.getElementById('items-list');
      const orderDiv = document.getElementById('order-items');
      
      itemsList.innerHTML = '';
      currentOrder.items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = `item ${item.found >= item.quantity ? 'found' : 'pending'}`;
        itemDiv.innerHTML = `
          <strong>${item.name}</strong> (${item.barcode})<br>
          Need: ${item.quantity} | Found: ${item.found} 
          ${item.found >= item.quantity ? '‚úÖ' : '‚è≥'}
        `;
        itemsList.appendChild(itemDiv);
      });
      
      orderDiv.style.display = 'block';
    }
    
    function handleBarcodeScan(barcode) {
      document.getElementById('result').value = barcode;
      
      // Show cooldown message
      const statusDiv = document.getElementById('workflow-status');
      const originalContent = statusDiv.innerHTML;
      statusDiv.innerHTML = `<h3>‚è≥ Processing... Please wait</h3>`;
      statusDiv.className = 'workflow-status';
      
      setTimeout(() => {
        statusDiv.innerHTML = originalContent;
      }, 750);
      
      if (workflowStep === "picking_slip") {
        // Step 1: Check if it's a picking slip
        setTimeout(() => {
          if (orders[barcode]) {
            currentOrder = orders[barcode];
            workflowStep = "items";
            updateWorkflowStatus(`
              <h3>‚úÖ Order Loaded: ${currentOrder.orderId}</h3>
              <p>Now scan items from the warehouse</p>
            `, "success");
            displayOrderItems();
          } else {
            updateWorkflowStatus(`
              <h3>‚ùå Invalid Picking Slip</h3>
              <p>Barcode: ${barcode} not found. Try: 012345678905</p>
            `, "error");
          }
        }, 750);
      } else if (workflowStep === "items") {
        // Step 2: Check if scanned item is in the order
        const item = currentOrder.items.find(i => i.barcode === barcode);
        
        setTimeout(() => {
          if (item) {
            if (item.found < item.quantity) {
              item.found++;
              updateWorkflowStatus(`
                <h3>‚úÖ Item Found!</h3>
                <p>${item.name} - ${item.found}/${item.quantity} collected</p>
              `, "success");
              displayOrderItems();
              
              // Check if order is complete
              const allFound = currentOrder.items.every(i => i.found >= i.quantity);
              if (allFound) {
                updateWorkflowStatus(`
                  <h3>üéâ Order Complete!</h3>
                  <p>All items collected for order ${currentOrder.orderId}</p>
                `, "success");
              }
            } else {
              updateWorkflowStatus(`
                <h3>‚ö†Ô∏è Item Already Complete</h3>
                <p>${item.name} - Already collected ${item.quantity}/${item.quantity}</p>
              `, "error");
            }
          } else {
            updateWorkflowStatus(`
              <h3>‚ùå Item Not in Order</h3>
              <p>Barcode: ${barcode} is not required for this order</p>
            `, "error");
          }
        }, 750);}
      }

    
    async function startScanner() {
      if (isScanning) return;
      
      // Check Native Barcode API support
      if (!('BarcodeDetector' in window)) {
        updateWorkflowStatus(`
          <h3>‚ö†Ô∏è Browser Not Supported</h3>
          <p>Use Chrome 83+ or Edge 83+ for best performance</p>
        `, "error");
        return;
      }
      
      try {
        // Create barcode detector
        barcodeDetector = new BarcodeDetector({
          formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code', 'data_matrix']
        });
        
        // Get camera stream
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        
        // Setup camera controls
        setupCameraControls();
        
        // Start scanning loop with rate limiting
        scanInterval = setInterval(async () => {
          try {
            const now = Date.now();
            if (now - lastScanTime < SCAN_COOLDOWN) {
              return; // Skip if within cooldown period
            }
            
            const barcodes = await barcodeDetector.detect(video);
            
            if (barcodes.length > 0) {
              const barcode = barcodes[0];
              lastScanTime = now;
              handleBarcodeScan(barcode.rawValue);
              if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
          } catch (err) {
            console.error('Detection error:', err);
          }
        }, 200); // Check every 200ms
        
        isScanning = true;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('stop-btn').style.display = 'block';
        
      } catch (err) {
        updateWorkflowStatus(`ERROR: ${err.message}`, "error");
      }
    }
    
    function stopScanner() {
      if (!isScanning) return;
      
      if (scanInterval) {
        clearInterval(scanInterval);
      }
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      isScanning = false;
      document.getElementById('start-btn').style.display = 'block';
      document.getElementById('stop-btn').style.display = 'none';
    }
    
    function toggleSettings() {
      const content = document.getElementById('settings-content');
      content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }
    
    function setupCameraControls() {
      if (!videoTrack) return;
      
      const capabilities = videoTrack.getCapabilities();
      document.getElementById('capabilities').textContent = Object.keys(capabilities).join(', ') || 'None available';
      
      // Setup zoom if available
      if (capabilities.zoom) {
        const zoomSlider = document.getElementById('zoom');
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step || 0.1;
        zoomSlider.value = capabilities.zoom.min;
        
        zoomSlider.addEventListener('input', async (e) => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ zoom: parseFloat(e.target.value) }]
            });
            document.getElementById('zoom-value').textContent = e.target.value + 'x';
          } catch (err) {
            console.error('Zoom error:', err);
          }
        });
      }
    }
    
    async function resetZoom() {
      if (!videoTrack) return;
      
      try {
        const capabilities = videoTrack.getCapabilities();
        const minZoom = capabilities.zoom ? capabilities.zoom.min : 1;
        
        await videoTrack.applyConstraints({
          advanced: [{ zoom: minZoom }]
        });
        
        document.getElementById('zoom').value = minZoom;
        document.getElementById('zoom-value').textContent = minZoom + 'x';
      } catch (err) {
        console.error('Reset zoom error:', err);
      }
    }
    
    async function toggleTorch() {
      if (!videoTrack) return;
      
      try {
        const capabilities = videoTrack.getCapabilities();
        if (capabilities.torch) {
          const settings = videoTrack.getSettings();
          await videoTrack.applyConstraints({
            advanced: [{ torch: !settings.torch }]
          });
        } else {
          alert('Flashlight not supported on this device');
        }
      } catch (err) {
        console.error('Torch error:', err);
      }
    }
  </script>
</body>
</html>