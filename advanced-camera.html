<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Camera Controls</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .container { padding: 20px; text-align: center; }
    #video { width: 500px; height: 200px; max-width: 90vw; border: 2px solid #007bff; object-fit: cover; }
    .controls { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .control-group { margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
    input[type="range"] { width: 200px; }
    button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .status { background: #e9ecef; padding: 10px; margin: 10px; border-radius: 5px; font-size: 14px; }
    input[type="text"] { width: 90%; padding: 15px; font-size: 18px; margin: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Advanced Camera Controls Scanner</h2>
    <p><a href="index.html">‚Üê Back to Scanner Selection</a></p>
    
    <div style="background: #fff3cd; padding: 10px; margin: 10px; border-radius: 5px;">
      <strong>üì∑ Camera Controls:</strong> Zoom, focus, brightness, and more (Chrome/Edge recommended)
    </div>
    
    <div style="position: relative; display: inline-block;">
      <video id="video" autoplay muted playsinline></video>
      <div class="scan-guide" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; border: 2px solid #00ff00; width: 250px; height: 150px; border-radius: 8px; background: rgba(0, 255, 0, 0.1);"></div>
    </div>
    
    <div class="controls" id="camera-controls" style="display: none;">
      <h3>Camera Controls</h3>
      
      <div class="control-group">
        <label>Zoom:</label>
        <input type="range" id="zoom" min="1" max="10" step="0.1" value="1">
        <span id="zoom-value">1x</span>
      </div>
      
      <div class="control-group">
        <label>Focus Distance:</label>
        <input type="range" id="focus" min="0" max="1" step="0.01" value="0.5">
        <span id="focus-value">0.5</span>
      </div>
      
      <div class="control-group">
        <label>Brightness:</label>
        <input type="range" id="brightness" min="0" max="2" step="0.1" value="1">
        <span id="brightness-value">1.0</span>
      </div>
      
      <div class="control-group">
        <label>Contrast:</label>
        <input type="range" id="contrast" min="0" max="2" step="0.1" value="1">
        <span id="contrast-value">1.0</span>
      </div>
      
      <div class="control-group">
        <button onclick="resetControls()">Reset All</button>
        <button onclick="toggleTorch()">Toggle Flashlight</button>
      </div>
    </div>
    
    <input type="text" id="result" placeholder="Scanned result appears here" readonly>
    <button id="start-btn" onclick="startScanner()">Start Scanner</button>
    <button id="stop-btn" onclick="stopScanner()" style="display:none;">Stop Scanner</button>
    
    <div class="status" id="status">
      Camera controls available: <span id="capabilities">Checking...</span>
    </div>
  </div>

  <script>
    let barcodeDetector;
    let isScanning = false;
    let stream;
    let videoTrack;
    let scanInterval;
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 750;
    
    function updateStatus(message) {
      document.getElementById('capabilities').textContent = message;
    }
    
    async function startScanner() {
      if (isScanning) return;
      
      // Check Native Barcode API support
      if (!('BarcodeDetector' in window)) {
        updateStatus('Browser not supported - use Chrome/Edge');
        return;
      }
      
      try {
        // Create barcode detector
        barcodeDetector = new BarcodeDetector({
          formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code', 'data_matrix']
        });
        
        // Get camera stream with high resolution
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        videoTrack = stream.getVideoTracks()[0];
        
        // Check camera capabilities
        const capabilities = videoTrack.getCapabilities();
        updateStatus(JSON.stringify(Object.keys(capabilities)));
        
        // Show controls if capabilities exist
        if (Object.keys(capabilities).length > 0) {
          document.getElementById('camera-controls').style.display = 'block';
          setupControls(capabilities);
        }
        
        // Start scanning
        scanInterval = setInterval(async () => {
          try {
            const now = Date.now();
            if (now - lastScanTime < SCAN_COOLDOWN) return;
            
            const barcodes = await barcodeDetector.detect(video);
            if (barcodes.length > 0) {
              const barcode = barcodes[0];
              lastScanTime = now;
              document.getElementById('result').value = barcode.rawValue;
              if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
          } catch (err) {
            console.error('Detection error:', err);
          }
        }, 200);
        
        isScanning = true;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('stop-btn').style.display = 'block';
        
      } catch (err) {
        updateStatus('Error: ' + err.message);
      }
    }
    
    function setupControls(capabilities) {
      // Setup zoom control
      if (capabilities.zoom) {
        const zoomSlider = document.getElementById('zoom');
        zoomSlider.min = capabilities.zoom.min;
        zoomSlider.max = capabilities.zoom.max;
        zoomSlider.step = capabilities.zoom.step || 0.1;
        zoomSlider.value = capabilities.zoom.min;
        
        zoomSlider.addEventListener('input', async (e) => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ zoom: parseFloat(e.target.value) }]
            });
            document.getElementById('zoom-value').textContent = e.target.value + 'x';
          } catch (err) {
            console.error('Zoom error:', err);
          }
        });
      }
      
      // Setup focus control
      if (capabilities.focusDistance) {
        const focusSlider = document.getElementById('focus');
        focusSlider.min = capabilities.focusDistance.min;
        focusSlider.max = capabilities.focusDistance.max;
        focusSlider.step = capabilities.focusDistance.step || 0.01;
        
        focusSlider.addEventListener('input', async (e) => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ focusDistance: parseFloat(e.target.value) }]
            });
            document.getElementById('focus-value').textContent = e.target.value;
          } catch (err) {
            console.error('Focus error:', err);
          }
        });
      }
      
      // Setup brightness control
      if (capabilities.brightness) {
        const brightnessSlider = document.getElementById('brightness');
        brightnessSlider.min = capabilities.brightness.min;
        brightnessSlider.max = capabilities.brightness.max;
        brightnessSlider.step = capabilities.brightness.step || 0.1;
        
        brightnessSlider.addEventListener('input', async (e) => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ brightness: parseFloat(e.target.value) }]
            });
            document.getElementById('brightness-value').textContent = e.target.value;
          } catch (err) {
            console.error('Brightness error:', err);
          }
        });
      }
      
      // Setup contrast control
      if (capabilities.contrast) {
        const contrastSlider = document.getElementById('contrast');
        contrastSlider.min = capabilities.contrast.min;
        contrastSlider.max = capabilities.contrast.max;
        contrastSlider.step = capabilities.contrast.step || 0.1;
        
        contrastSlider.addEventListener('input', async (e) => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ contrast: parseFloat(e.target.value) }]
            });
            document.getElementById('contrast-value').textContent = e.target.value;
          } catch (err) {
            console.error('Contrast error:', err);
          }
        });
      }
    }
    
    async function resetControls() {
      if (!videoTrack) return;
      
      try {
        await videoTrack.applyConstraints({
          advanced: [{}] // Reset to defaults
        });
        
        // Reset sliders
        document.getElementById('zoom').value = 1;
        document.getElementById('focus').value = 0.5;
        document.getElementById('brightness').value = 1;
        document.getElementById('contrast').value = 1;
        
        // Update displays
        document.getElementById('zoom-value').textContent = '1x';
        document.getElementById('focus-value').textContent = '0.5';
        document.getElementById('brightness-value').textContent = '1.0';
        document.getElementById('contrast-value').textContent = '1.0';
        
      } catch (err) {
        console.error('Reset error:', err);
      }
    }
    
    async function toggleTorch() {
      if (!videoTrack) return;
      
      try {
        const capabilities = videoTrack.getCapabilities();
        if (capabilities.torch) {
          const settings = videoTrack.getSettings();
          await videoTrack.applyConstraints({
            advanced: [{ torch: !settings.torch }]
          });
        } else {
          updateStatus('Flashlight not supported on this device');
        }
      } catch (err) {
        console.error('Torch error:', err);
      }
    }
    
    function stopScanner() {
      if (!isScanning) return;
      
      if (scanInterval) {
        clearInterval(scanInterval);
      }
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      isScanning = false;
      document.getElementById('start-btn').style.display = 'block';
      document.getElementById('stop-btn').style.display = 'none';
      document.getElementById('camera-controls').style.display = 'none';
    }
  </script>
</body>
</html>